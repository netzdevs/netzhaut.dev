From bc79b0851df5427401418f9ed6539bb7ab0adb0b Mon Sep 17 00:00:00 2001
From: Dajo Frey <dajo.frey@gmail.com>
Date: Tue, 24 May 2022 18:24:28 +0200
Subject: [PATCH] Make temporary terminal font selection more robust.

---
 CHANGES.txt                            |  1 +
 src/lib/nhterminal/Terminal/Terminal.c | 11 ++++++++++-
 2 files changed, 11 insertions(+), 1 deletion(-)
 create mode 100644 CHANGES.txt

diff --git a/CHANGES.txt b/CHANGES.txt
new file mode 100644
index 0000000..4d03501
--- /dev/null
+++ b/CHANGES.txt
@@ -0,0 +1 @@
+changes{date:"2022-05-24"summary:"Make temporary terminal font selection more robust."author{name:"Dajo Frey"contact:"https://github.com/dajofrey"}workload{scope:"patch"lib:"nhterminal"}}
diff --git a/src/lib/nhterminal/Terminal/Terminal.c b/src/lib/nhterminal/Terminal/Terminal.c
index 19811ed..5294708 100644
--- a/src/lib/nhterminal/Terminal/Terminal.c
+++ b/src/lib/nhterminal/Terminal/Terminal.c
@@ -83,7 +83,16 @@ NH_TERMINAL_BEGIN()
 
         nh_gfx_Text Text;
         NH_ENCODING_UTF32 c = 'e';
-        nh_gfx_createTextFromFont(&Text, &c, 1, Terminal_p->Graphics.fontSize, Terminal_p->Graphics.Fonts.pp[0]);
+
+        NH_GFX_RESULT failure = 1;
+        for (int i = 0; i < Terminal_p->Graphics.Fonts.size; ++i) {
+            failure = nh_gfx_createTextFromFont(&Text, &c, 1, Terminal_p->Graphics.fontSize, Terminal_p->Graphics.Fonts.pp[i]);
+            if (!failure) {
+                Terminal_p->Graphics.font = i;
+                break;
+            }
+        }
+        if (failure) {NH_TERMINAL_END(NH_TERMINAL_ERROR_BAD_STATE)}
 
         Terminal_p->Grid.Size.width = Terminal_p->Graphics.Viewport_p->Settings.Size.width;
         Terminal_p->Grid.Size.height = Terminal_p->Graphics.Viewport_p->Settings.Size.height;
-- 
2.36.1

